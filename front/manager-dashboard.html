<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manager Dashboard</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.1.3/css/bootstrap.min.css">
  <style>
    .task-item {
      background-color: #f8f9fa;
      margin-bottom: 15px;
    }
    .nav-tabs {
      margin-bottom: 20px;
    }
    .tab-content {
      padding: 20px;
      border: 1px solid #dee2e6;
      border-top: none;
      border-radius: 0 0 5px 5px;
    
    }
    .logout-btn {
      position: absolute;
      right: 20px;
      top: 20px;
    }
  </style>
</head>
<body>
<button class="btn btn-danger logout-btn" onclick="logout()">Logout</button>
<div class="container mt-4">
  <h2 class="text-center">Manager Dashboard</h2>
  <ul class="nav nav-tabs" id="dashboardTabs">
    <li class="nav-item">
      <a class="nav-link active" data-bs-toggle="tab" href="#addEmployee">Add Employee</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#createTask">Create Task</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#taskList">View Tasks</a>
    </li>
  </ul>

  <div class="tab-content mt-3">
    <!-- Add Employee Tab -->
    <div class="tab-pane fade show active" id="addEmployee">
      <h4>Add Employee</h4>
      <form id="addEmployeeForm" class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Username</label>
          <input type="text" class="form-control" id="username" name="username" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Email</label>
          <input type="email" class="form-control" id="email" name="email" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Password</label>
          <input type="password" class="form-control" id="password" name="password" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Role</label>
          <select class="form-control" id="role" name="role" required>
            <option value="manager">Manager</option>
            <option value="employee">Employee</option>
          </select>
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-primary">Add Employee</button>
        </div>
      </form>
    </div>

    <!-- Create Task Tab -->
    <div class="tab-pane fade" id="createTask">
      <h4>Create Task</h4>
      <form id="createTaskForm" class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Title</label>
          <input type="text" class="form-control" id="title" name="title" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Assign To (Employee ID)</label>
          <input type="number" class="form-control" id="assignedTo" name="assignedTo" required>
        </div>
        <div class="col-12">
          <label class="form-label">Description</label>
          <textarea class="form-control" id="description" name="description" required></textarea>
        </div>
        <div class="col-md-4">
          <label class="form-label">Status</label>
          <select class="form-control" id="status" name="status" required>
            <option value="PENDING">Pending</option>
            <option value="IN_PROGRESS">In Progress</option>
            <option value="COMPLETED">Completed</option>
          </select>
        </div>
        <div class="col-md-4">
            <label class="form-label">Deadline</label>
            <input type="datetime-local" class="form-control" id="deadline" name="deadline" required>
          </div>
        <div class="col-12">
          <button type="submit" class="btn btn-success">Create Task</button>
        </div>
      </form>
    </div>

    <!-- View Tasks Tab -->
    <div class="tab-pane fade" id="taskList">
      <h4>All Tasks</h4>
      <div class="row mb-3">
        <div class="col-md-4">
          <label>Filter by Status</label>
          <select id="statusFilter" class="form-control">
            <option value="">All</option>
            <option value="PENDING">Pending</option>
            <option value="IN_PROGRESS">In Progress</option>
            <option value="COMPLETED">Completed</option>
          </select>
        </div>
        <div class="col-md-4 mt-4">
          <button class="btn btn-primary" onclick="filterByStatus()">Apply Filter</button>
        </div>
      </div>
      <div id="taskContainer">
        <!-- Tasks will be loaded here dynamically -->
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    checkAuth();
    
    // Initialize tab functionality
    const taskListTab = document.querySelector('[href="#taskList"]');
    taskListTab.addEventListener('shown.bs.tab', function() {
      filterByStatus();
    });
  });

  // Authentication check
  function checkAuth() {
    const token = getToken();
    if (!token) {
      redirectToLogin();
    }
  }

  // Get token from localStorage
  function getToken() {
    const token = localStorage.getItem("token");
    if (!token) {
      return null;
    }
    return token;
  }

  // Redirect to login page
  function redirectToLogin() {
    window.location.href = "/login.html"; // Update with your login page path
  }

  // Logout function
  function logout() {
    localStorage.removeItem("token");
    redirectToLogin();
  }

  // Add Employee Form Submission
  document.getElementById('addEmployeeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const token = getToken();
    if (!token) {
      redirectToLogin();
      return;
    }

    fetch('http://localhost:8080/manager/add-user', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}` // Added Bearer prefix
      },
      body: JSON.stringify({
        name: document.getElementById('username').value,
        email: document.getElementById('email').value,
        password: document.getElementById('password').value,
        role: document.getElementById('role').value
      })
    })
    .then(async res => {
      if (res.status === 401) {
        redirectToLogin();
        return;
      }
      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.message || 'Failed to add employee');
      }
      return res.text();
    })
    .then(data => {
      alert("User added successfully!");
      document.getElementById('addEmployeeForm').reset();
    })
    .catch(err => {
      console.error(err);
      alert("Error: " + err.message);
    });
  });

  // Create Task Form Submission
  document.getElementById('createTaskForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const token = getToken();
    if (!token) {
      redirectToLogin();
      return;
    }

    fetch('http://localhost:8080/tasks/manager', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}` // Added Bearer prefix
      },
      body: JSON.stringify({
        title: document.getElementById('title').value,
        description: document.getElementById('description').value,
        deadline: document.getElementById('deadline').value,
        status: document.getElementById('status').value,
        assignedTo: document.getElementById('assignedTo').value
      })
    })
    .then(async res => {
      if (res.status === 401) {
        redirectToLogin();
        return;
      }
      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.message || 'Failed to create task');
      }
      return res.json();
    })
    .then(data => {
      alert("Task created successfully!");
      document.getElementById('createTaskForm').reset();
    })
    .catch(err => {
      console.error(err);
      alert("Error: " + err.message);
    });
  });

  // Task Filtering Function
  function filterByStatus() {
  const status = document.getElementById("statusFilter").value;
  const token = getToken();
  if (!token) {
    redirectToLogin();
    return;
  }

  let url = 'http://localhost:8080/tasks/manager';
  if (status) {
    url = `http://localhost:8080/tasks/status?status=${status}`;
  }

  fetch(url, {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
  .then(async res => {
    if (res.status === 401) {
      redirectToLogin();
      return;
    }
    if (!res.ok) {
      const error = await res.json();
      throw new Error(error.message || 'Failed to fetch tasks');
    }
    return res.json();
  })
  .then(tasks => {
    const container = document.getElementById("taskContainer");
    container.innerHTML = "";
    
    if (!tasks || tasks.length === 0) {
      container.innerHTML = "<p>No tasks found</p>";
      return;
    }

    tasks.forEach(task => {
      const div = document.createElement("div");
      div.className = "task-item p-3 mb-3 border rounded";
      
      // Format deadline for display
      const deadlineDate = task.deadline ? new Date(task.deadline) : null;
      const deadlineStr = deadlineDate ? 
        deadlineDate.toLocaleString() : 'No deadline';
      
      // Use task.assignedTo instead of task.employeeId
      div.innerHTML = `
        <h4>${task.title}</h4>
        <p>${task.description}</p>
        <p><strong>Status:</strong> ${task.status}</p>
        <p><strong>Assigned to:</strong> #${task.assignedTo}</p>
        <p><strong>Deadline:</strong> ${deadlineStr}</p>
        <button class="btn btn-info btn-sm me-2" onclick="viewTask(${task.id})">View Details</button>
        <button class="btn btn-danger btn-sm" onclick="deleteTask(${task.id})">Delete</button>
      `;
      container.appendChild(div);
    });
  })
  .catch(err => {
    console.error("Error fetching tasks:", err);
    alert("Error fetching tasks: " + err.message);
  });
}

  // View Task Details
  function viewTask(id) {
  const token = getToken();
  if (!token) {
    redirectToLogin();
    return;
  }

  fetch(`http://localhost:8080/tasks/${id}`, {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
  .then(async res => {
    if (res.status === 401) {
      redirectToLogin();
      return;
    }
    if (!res.ok) {
      const error = await res.json();
      throw new Error(error.message || 'Failed to fetch task details');
    }
    return res.json();
  })
  .then(task => {
    const deadlineDate = task.deadline ? new Date(task.deadline) : null;
    const deadlineStr = deadlineDate ? 
      deadlineDate.toLocaleString() : 'No deadline';
    
    alert(`Task Details:\n\nTitle: ${task.title}\nDescription: ${task.description}\nStatus: ${task.status}\nAssigned to: #${task.assignedTo}\nDeadline: ${deadlineStr}`);
  })
  .catch(err => {
    console.error("Error viewing task:", err);
    alert("Error viewing task: " + err.message);
  });
}

  // Delete Task
  function deleteTask(id) {
    if (!confirm("Are you sure you want to delete this task?")) {
      return;
    }

    const token = getToken();
    if (!token) {
      redirectToLogin();
      return;
    }

    fetch(`http://localhost:8080/tasks/manager/${id}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}` // Added Bearer prefix
      }
    })
    .then(async res => {
      if (res.status === 401) {
        redirectToLogin();
        return;
      }
      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.message || 'Failed to delete task');
      }
      alert("Task deleted successfully");
      filterByStatus(); // Refresh the task list
    })
    .catch(err => {
      console.error(err);
      alert("Error deleting task: " + err.message);
    });
  }
</script>
</body>
</html>